<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Capability Discovery - Paymail</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="index.html">Overview</a></li><li><a href="01-brfc-specifications.html"><strong aria-hidden="true">1.</strong> BRFC Specifications</a></li><li><ol class="section"><li><a href="01-01-specification-documents.html"><strong aria-hidden="true">1.1.</strong> Specification Documents</a></li><li><a href="01-02-brfc-id-assignment.html"><strong aria-hidden="true">1.2.</strong> BRFC ID Assignment</a></li></ol></li><li><a href="02-service-discovery.html"><strong aria-hidden="true">2.</strong> Service Discovery</a></li><li><ol class="section"><li><a href="02-01-host-discovery.html"><strong aria-hidden="true">2.1.</strong> Host Discovery</a></li><li><a href="02-02-capability-discovery.html" class="active"><strong aria-hidden="true">2.2.</strong> Capability Discovery</a></li></ol></li><li><a href="03-public-key-infrastructure.html"><strong aria-hidden="true">3.</strong> Public Key Infrastructure</a></li><li><a href="04-payment-addressing.html"><strong aria-hidden="true">4.</strong> Payment Addressing</a></li><li><ol class="section"><li><a href="04-01-basic-address-resolution.html"><strong aria-hidden="true">4.1.</strong> Basic Address Resolution</a></li><li><a href="04-02-sender-validation.html"><strong aria-hidden="true">4.2.</strong> Sender Validation</a></li><li><a href="04-03-receiver-approvals.html"><strong aria-hidden="true">4.3.</strong> Receiver Approvals</a></li><li><a href="04-04-payto-protocol-prefix.html"><strong aria-hidden="true">4.4.</strong> PayTo Protocol Prefix</a></li></ol></li><li><a href="05-verify-public-key-owner.html"><strong aria-hidden="true">5.</strong> Verify Public Key Owner</a></li><li class="affix"><a href="99-01-recommendations.html">Recommendations</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Paymail</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#capability-discovery" id="capability-discovery"><h1>Capability Discovery</h1></a>
<p>Following on from <a href="02-01-host-discovery.html">Host Discovery</a>, the next step a paymail client performs is Capability Discovery.</p>
<p>Capability Discovery is the process by which a paymail client learns the supported features of a paymail service and their respective endpoints and configurations.</p>
<p>Drawing inspiration from <a href="https://tools.ietf.org/html/rfc5785">RFC 5785</a> and IANA's <a href="https://www.iana.org/assignments/well-known-uris/well-known-uris.xhtml">Well-Known URIs</a> resource, the Capability Discovery protocol dictates that a machine-readable document is placed in a predictable location on a web server.</p>
<a class="header" href="#setup" id="setup"><h2>Setup</h2></a>
<p>A paymail service operator creates a JSON formatted text file at the following location:</p>
<p><code>https://&lt;host-discovery-target&gt;:&lt;host-discovery-port&gt;/.well-known/bsvalias</code>.</p>
<ul>
<li>The file name <code>bsvalias</code> is chosen to allow implementers to move forward with a stable specification whilst the final product name is under consideration</li>
<li>The file <em>MUST</em> be served over HTTPS</li>
<li>The value of the HTTP <code>Content-Type</code> header <em>MUST</em> be set to <code>application/json</code> and optionally <em>MAY</em> indicate a schema as an attribute, for example <code>application/json; schema=&quot;https://schemas.nchain.com/bsvalias/1.0/capability-discovery&quot;</code></li>
<li>The successful response status code <em>MUST</em> be either <code>200</code> (OK) if the <code>bsvalias</code> file exists, or <code>304</code> (Not Modified) if valid cache query headers are supplied within the request.</li>
<li>The response <em>MAY</em> indicate the document's validity via standard HTTP caching and expiry related headers. Operators are advised to consider configuring their web server to support the broadest range of supported client caching mechanisms, including <code>Cache-Control</code>, <code>Last-Modified</code>/<code>If-Modified-Since</code>, <code>Etag</code>, and <code>Expires</code>. Many standard clients and libraries implement standards-compliant caching behaviour. Further details are available from <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching">MDN</a></li>
<li>The <code>bsvalias</code> file must conform to the following format:</li>
</ul>
<pre><code class="language-json">    {
      &quot;bsvalias&quot;: &quot;1.0&quot;,
      &quot;capabilities&quot;: {
        &quot;pki&quot;: &quot;https://bsvalias.example.org/{alias}@{domain.tld}/id&quot;,
        &quot;paymentDestination&quot;: &quot;https://bsvalias.example.org/{alias}@{domain.tld}/payment-destination&quot;
      }
    }

</code></pre>
<ul>
<li>The template values <code>{alias}</code> and <code>{domain.tld}</code> refer to the components of paymail handle format <code>&lt;alias&gt;@&lt;domain&gt;.&lt;tld&gt;</code> and are literal; clients are expected to replace them wherever they appear in the endpoint URI with the actual values from the paymail handle</li>
<li>Additional BRFCs may extend this document. It is a matter for each specification author to describe the data structure required for their particular protocol, however the location of that data structure must be a key within the <code>capabilities</code> object named after the BRFC ID. As an example, a (fictional) BRFC with ID <code>001122334455</code> requires a simple boolean flag in addition to an endpoint URI. It would extend the <code>.well-known/bsvalias</code> document like this:</li>
</ul>
<pre><code class="language-json">    {
      &quot;bsvalias&quot;: &quot;1.0&quot;,
      &quot;capabilities&quot;: {
        &quot;001122334455&quot;: {
          &quot;endpoint&quot;: &quot;https://bsvalias.example.org/{alias}@{domain.tld}/example&quot;,
          &quot;flag&quot;: true
        }
      }
    }

</code></pre>
<p>Note that the capabilities <code>pki</code> and <code>paymentDestination</code> are not named for their BRFC IDs, as these are the minimum set of capabilities required for a service to qualify as a paymail service and are treated as special cases.</p>
<a class="header" href="#client-queries" id="client-queries"><h2>Client Queries</h2></a>
<p>Having retrieved a <code>Target</code>:<code>Port</code> pair using Host Discovery, a paymail client constructs an HTTP GET request to <code>https://&lt;target&gt;:&lt;port&gt;/.well-known/bsvalias</code>, including caching hints from previous requests (if any).</p>
<p>Following a successful request, clients have now discovered all configuration information required for interacting with a paymail service and are aware of all supported extension protocols offered by the remote.</p>
<a class="header" href="#changes-from-previous-versions" id="changes-from-previous-versions"><h2>Changes from previous versions</h2></a>
<p>In the original drafts, the <code>bsvalias</code> file was a text based, tab-delimited list of <code>&lt;domain&gt;.&lt;tld&gt; \tab https://&lt;base-uri&gt;</code> pairs.</p>
<ul>
<li>This was removed to avoid data leakage about domains hosted by a given paymail service</li>
<li>The format was changed from tab-delimited text to JSON</li>
<li>Capability Discovery was merged into the previous Address Discovery base URI approach</li>
<li>A paymail (<code>bsvalias</code>) version field was added for forward compatibility, although its interpretation is unspecified at this time</li>
</ul>
<a class="header" href="#design-considerations" id="design-considerations"><h2>Design Considerations</h2></a>
<p>In a previous version of this specification, this step of the service discovery returned a base URI from which all request URIs would be built. It was suggested that the <code>.well-known/bsvalias</code> document merge a separate capability discovery which was originally planned to exist at <code>&lt;base-uri&gt;/capabilities</code>. In doing so, the following points were considered:</p>
<a class="header" href="#capabilities-differ-by-domain-and-by-user-within-a-domain" id="capabilities-differ-by-domain-and-by-user-within-a-domain"><h3>Capabilities differ by domain and by user within a domain</h3></a>
<ul>
<li>Service providers hosting multiple domains may offer different capabilities at different price points</li>
<li>Administrators may enable or disable capabilities on a per-user bases</li>
</ul>
<p>A single <code>.well-known/bsvalias</code> document cannot describe the per-alias/per-domain capabilities. Instead it describes the services supported by the implementation, regardless of account-level availability. Where a paymail implementation supports a particular protocol but it is not enabled for a given account, upon receiving a request that will not be fulfilled, a <code>404</code> (Not Found) response should be given. This is (deliberately) indistinguishable from <code>{alias}</code>/<code>{domain.tld}</code> not found.</p>
<a class="header" href="#simplified-clientrequest-flow" id="simplified-clientrequest-flow"><h3>Simplified client/request flow</h3></a>
<p>Merging capability discovery reduces the amount of requests made in order to locate a given service endpoint, and simplifies client implementations.</p>
<a class="header" href="#more-complicated-deployment" id="more-complicated-deployment"><h3>More complicated deployment</h3></a>
<p>One drawback of merging the two phases of discovery is that <code>.well-known/bsvalias</code> is no longer <em>set-and-forget</em>.</p>
<p>Prior to merging these to functions, a redeployment of the paymail service implementation may deliver new capabilities. These would be automatically discovered by clients.</p>
<p>Having merged service location and capability discovery into <code>.well-known/bsvalias</code>, this file must also be updated when a service deployment delivers enhanced capabilities. It is recommended that implementers of server software deliver an endpoint that can generate a valid <code>.well-known/bsvalias</code> response, and that operators configure a proxy to transparently service this implementation-provided endpoint when a request for the well known capabilities file is received.</p>
<p>Copyright 2019 nChain and Money Button</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="02-01-host-discovery.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="03-public-key-infrastructure.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="02-01-host-discovery.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="03-public-key-infrastructure.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
